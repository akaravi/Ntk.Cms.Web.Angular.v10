<div class="cms-m-body loader-container">
  <app-progress-spinner [optionsInfoAreaId]="constructorInfoAreaId">
  </app-progress-spinner>

  <!-- Header با Safe Area برای iPhone -->
  <div class="cms-m-header safe-area-top">
    <div class="cms-m-header-content">
      <button
        type="button"
        class="cms-m-back-btn"
        (click)="onActionBackToParent()"
        aria-label="{{ 'ACTION.BACK' | translate }}"
      >
        <i class="fa-solid fa-arrow-right" aria-hidden="true"></i>
      </button>
      <h1 class="cms-m-header-title">
        {{ formInfo.formTitle || ("ROUTE.ESTATE.SUPPLIER" | translate) }}
      </h1>
      <div class="cms-m-header-spacer"></div>
    </div>
  </div>

  <!-- Content Area -->
  <div class="cms-m-content safe-area-content">
    <app-cms-form-result-message [formInfo]="formInfo">
    </app-cms-form-result-message>

    <form (ngSubmit)="onFormSubmit()" #vform="ngForm">
      <mat-vertical-stepper
        (selectionChange)="onStepClick($event, stepper)"
        #stepper
      >
        <mat-step
          label="{{ 'TITLE.REQUIRED_INFORMATION' | translate }}"
          state="main"
        >
          <!-- RecordStatus Field -->
          @if (fieldsInfo["recordStatus"]?.accessWatchField) {
            <app-cms-enum-record-status-selector
              [(model)]="dataModel.recordStatus"
              [optionDisabled]="false"
              [optionLabel]="fieldsInfo['recordStatus']?.fieldTitle"
              [optionRequired]="true"
              [optionSelectFirstItem]="true"
            ></app-cms-enum-record-status-selector>
          }

          <!-- Title Field -->
          <div class="cms-m-form-field">
            <label class="cms-m-form-label">{{
              fieldsInfo["title"]?.fieldTitle
            }}</label>
            <input
              matInput
              type="text"
              [(ngModel)]="dataModel.title"
              name="dataModel.title"
              #Title
              placeholder="{{ fieldsInfo['title']?.fieldTitle }}"
              [disabled]="!fieldsInfo['title']?.accessAddField"
              minlength="3"
              maxlength="100"
              required
              class="cms-m-form-input"
              id="dataModel.title"
            />
            <em class="cms-m-char-count">{{ Title.value.length }} / 100</em>
            @if (Title.errors?.required) {
              <mat-error>
                Title is
                <strong>{{ "MESSAGE.required" | translate }}</strong>
              </mat-error>
            }
          </div>

          <!-- Description Field -->
          <div class="cms-m-form-field">
            <label class="cms-m-form-label">{{
              fieldsInfo["description"]?.fieldTitle
            }}</label>
            <textarea
              matInput
              [(ngModel)]="dataModel.description"
              name="dataModel.description"
              #Description
              placeholder="{{ fieldsInfo['description']?.fieldTitle }}"
              [disabled]="!fieldsInfo['description']?.accessAddField"
              minlength="1"
              maxlength="500"
              rows="5"
              id="dataModel.description"
              class="cms-m-form-textarea"
            ></textarea>
            <em class="cms-m-char-count"
              >{{ Description.value.length }} / 500</em
            >
            @if (Description.errors?.required) {
              <mat-error>
                Description is
                <strong>{{ "MESSAGE.required" | translate }}</strong>
              </mat-error>
            }
          </div>

          <!-- LinkMainImageId Field -->
          @if (dataModel?.linkMainImageIdSrc?.length > 0) {
            <div class="cms-m-form-field">
              <label class="cms-m-form-label">{{
                "TITLE.PICTURE" | translate
              }}</label>
              <a
                href="{{ dataModel.linkMainImageIdSrc | cmsthumbnail }}"
                target="_blank"
                class="cms-m-image-preview"
              >
                <img
                  src="{{ dataModel.linkMainImageIdSrc | cmsthumbnail }}"
                  alt="Preview"
                />
              </a>
            </div>
          }
          <div class="cms-m-form-field">
            <label class="cms-m-form-label">{{
              "TITLE.PICTURE" | translate
            }}</label>
            <input
              matInput
              type="text"
              [(ngModel)]="dataModel.linkMainImageId"
              name="dataModel.linkMainImageId"
              #LinkMainImageId
              placeholder="{{ 'TITLE.Original_File_ID' | translate }}"
              autocomplete="off"
              (click)="fileManagerOpenForm = true"
              class="cms-m-form-input"
              id="dataModel.linkMainImageId"
            />
            <cms-file-manager
              (itemSelected)="onActionFileSelected($event)"
              [language]="appLanguage"
              [isPopup]="true"
              [openSelectFileDescription]="
                'TITLE.The_dimensions_of_the_photo_should_be_600_x_600' | translate
              "
              [(openForm)]="fileManagerOpenForm"
              [tree]="fileManagerTree"
              [openFilemanagerButtonLabelKey]="'select'"
              [openDirectUploadView]="true"
              [selectFileType]="selectFileTypeMainImage"
              [openFilemanagerButtonView]="false"
            >
            </cms-file-manager>
          </div>

          <!-- LinkLocationId Field -->
          @if (fieldsInfo["linkLocationId"]?.accessWatchField) {
            <div class="cms-m-form-field">
              <label class="cms-m-form-label">{{
                "TITLE.Region" | translate
              }}</label>
              <app-cms-location-selector
                (optionChange)="onActionSelectorLocation($event)"
                [optionDisabled]="!fieldsInfo['linkLocationId']?.accessAddField"
                [optionSelectForce]="dataModel.linkLocationId"
                [optionPlaceholder]="'TITLE.Region' | translate"
              >
              </app-cms-location-selector>
            </div>
          }

          <!-- Geolocationlatitude and Geolocationlongitude Fields -->
          @if (
            fieldsInfo["geolocationlatitude"]?.accessWatchField ||
            fieldsInfo["geolocationlongitude"]?.accessWatchField
          ) {
            <div class="cms-m-form-field">
              <label class="cms-m-form-label">{{
                "TITLE.Geolocation" | translate
              }}</label>
              <div class="row">
                <div class="col-6">
                  <input
                    matInput
                    type="number"
                    [(ngModel)]="dataModel.geolocationlatitude"
                    name="dataModel.geolocationlatitude"
                    #Geolocationlatitude
                    placeholder="{{
                      fieldsInfo['geolocationlatitude']?.fieldTitle
                    }}"
                    [disabled]="
                      !fieldsInfo['geolocationlatitude']?.accessAddField
                    "
                    class="cms-m-form-input"
                    id="dataModel.geolocationlatitude"
                  />
                </div>
                <div class="col-6">
                  <input
                    matInput
                    type="number"
                    [(ngModel)]="dataModel.geolocationlongitude"
                    name="dataModel.geolocationlongitude"
                    #Geolocationlongitude
                    placeholder="{{
                      fieldsInfo['geolocationlongitude']?.fieldTitle
                    }}"
                    [disabled]="
                      !fieldsInfo['geolocationlongitude']?.accessAddField
                    "
                    class="cms-m-form-input"
                    id="dataModel.geolocationlongitude"
                  />
                </div>
              </div>
              <div class="map-container">
                <app-cms-map
                  (optionChange)="receiveMap($event)"
                  (optionCenter)="mapOptonCenter"
                  (optionZoom)="receiveZoom($event)"
                  [optionMarkermap]="mapMarker"
                ></app-cms-map>
              </div>
            </div>
          }

          <div class="cms-m-stepper-actions">
            <button
              type="button"
              class="cms-m-btn cms-m-btn-secondary"
              (click)="onActionBackToParent()"
            >
              <i class="fa-solid fa-times" aria-hidden="true"></i>
              {{ "ACTION.CANCEL" | translate }}
            </button>
            <button
              type="button"
              class="cms-m-btn cms-m-btn-primary"
              matStepperNext
            >
              {{ "ACTION.NEXT" | translate }}
              <i class="fa-solid fa-arrow-left" aria-hidden="true"></i>
            </button>
          </div>
        </mat-step>

        <mat-step label="{{ 'TITLE.ADDITIONAL_INFORMATION' | translate }}">
          @if (formInfo.submitButtonEnabled) {
            <div class="cms-m-footer safe-area-bottom">
              <button
                type="button"
                class="cms-m-btn cms-m-btn-secondary"
                matStepperPrevious
              >
                <i class="fa-solid fa-arrow-right" aria-hidden="true"></i>
                {{ "ACTION.BACK" | translate }}
              </button>
              <button
                type="submit"
                class="cms-m-btn cms-m-btn-success"
                [disabled]="!vform.form.valid"
              >
                <i class="fa-solid fa-save" aria-hidden="true"></i>
                {{ "ACTION.SAVE" | translate }}
              </button>
            </div>
          }
        </mat-step>
      </mat-vertical-stepper>
    </form>
  </div>
</div>
